# Code generated by golangee/eearc; DO NOT EDIT.
# 
# Copyright 2021 Torben Schinke
# 
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
# 
#      https://www.apache.org/licenses/LICENSE-2.0
# 
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.


prefix ?= /usr/local
bindir ?= $(prefix)/bin
DESTDIR ?= ./build
TMPDIR ?= $(shell mktemp -d)

CI_JOB_ID ?= $(shell date +%s)
CI_COMMIT_TAG ?= $(shell git name-rev --name-only HEAD)
CI_JOB_STARTED_AT ?= $(shell date +"%Y-%m-%dT%T%z") # RFC3339 | ISO8601
CI_COMMIT_SHA ?= $(shell git rev-parse HEAD)
CI_SERVER_HOST ?= $(shell hostname)

UNAME := $(shell uname)
ifeq ($(UNAME),Darwin)
	openHugoCMD := open http://localhost:4563
endif

buildInfo = github.com/golangee/architecture/testdata/workspace/server/internal/buildinfo
LDFLAGS = -X $(buildInfo).JobID=${CI_JOB_ID} -X $(buildInfo).CommitTag=${CI_COMMIT_TAG} -X $(buildInfo).JobStartedAt=${CI_JOB_STARTED_AT} -X $(buildInfo).CommitSha=${CI_COMMIT_SHA} -X $(buildInfo).Host=${CI_SERVER_HOST}

# doc: #go install --tags=extended github.com/gohugoio/hugo@latest
path_supportiety_server = "github.com/golangee/architecture/testdata/workspace/server/cmd/supportiety-server"

test: ## Executes all tests.
	@go test -race -timeout=5m ./...
.PHONY: test

lint: ## Runs the linter. See golangci.yaml for details.
	@command -v golangci-lint > /dev/null 2>&1 || (cd $${TMPDIR} && go get github.com/golangci/golangci-lint/cmd/golangci-lint@v1.40.1)
	golangci-lint run --config golangci.yaml
.PHONY: lint

generate: ## runs go generate
	@go generate ./...
.PHONY: generate

help: ## Shows this help
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-30s\033[0m %s\n", $$1, $$2}'
.PHONY: help


run-supportiety-server: ## runs supportiety-server without installing
	go run -ldflags "${LDFLAGS}" $(path_supportiety_server)


# required by GNU standard

check: lint test ## build and runs tests and linters

install: ## builds and installs on the current system
	go build -ldflags "${LDFLAGS}" -o $(DESTDIR)$(bindir)/supportiety-server $(path_supportiety_server)
.PHONY: dist

dist: ## builds for all major platforms, example: make DESTDIR=/tmp/stage dist
	GOOS=darwin GOARCH=amd64 go build -ldflags "${LDFLAGS}" -o $(DESTDIR)/bin/darwin_amd64/supportiety-server $(path_supportiety_server)
	GOOS=linux GOARCH=amd64 go build -ldflags "${LDFLAGS}" -o $(DESTDIR)/bin/linux_amd64/supportiety-server $(path_supportiety_server)
.PHONY: dist


# download hugo theme only once
$(DESTDIR)/docs/html/themes/hugo-book/:
	mkdir -p $(DESTDIR)/docs/html/themes
	curl https://codeload.github.com/alex-shpak/hugo-book/zip/refs/heads/master --output $(DESTDIR)/docs/html/hugo-book.zip
	unzip $(DESTDIR)/docs/html/hugo-book.zip -d $(DESTDIR)/docs/html/themes/hugo-book
	mv $(DESTDIR)/docs/html/themes/hugo-book/hugo-book-master/* $(DESTDIR)/docs/html/themes/hugo-book
	rm -f $(DESTDIR)/docs/html/hugo-book.zip
	rm -rf $(DESTDIR)/docs/html/themes/hugo-book/hugo-book-master
	rm -rf $(DESTDIR)/docs/html/themes/hugo-book/images
	rm -rf $(DESTDIR)/docs/html/themes/hugo-book/exampleSite
	rm -f $(DESTDIR)/docs/html/themes/hugo-book/README.md

html: $(DESTDIR)/docs/html/themes/hugo-book/ ## generates the html documentation.
	rm -rf $(DESTDIR)/docs/html/content
	cp -R docs/ $(DESTDIR)/docs/html/
	cd $(DESTDIR)/docs/html/ && hugo 
.PHONY: html

serve-html: html ## builds the html documentation, serves it and opens a browser window
	$(openHugoCMD)
	cd $(DESTDIR)/docs/html/ && hugo server -D -p 4563
.PHONY: serve-html

clean:
	rm -rf $(DESTDIR)/docs
	rm -rf $(DESTDIR)/bin
.PHONY: clean

all: generate check dist ## generate, check and build dist
.PHONY: all

.DEFAULT_GOAL := all
